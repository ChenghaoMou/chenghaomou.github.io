---
aliases:
  - RAG 优化
title: "RAG 优化"
created: 2024-07-20
updated: 2024-07-20
modified: 2024-07-20
---

# RAG 优化

参考：[一文详谈20多种RAG优化方法](https://mp.weixin.qq.com/s/xMsPh8qicRD395vjFR250A)

## 数据处理

其实不管是 RAG 还是其他机器学习系统，输入数据的质量往往决定了模型或者输出质量的上限。对数据的优化处理往往能事半功倍。

从数据的来源角度出发，可以采用：

1. 数据增强：在现有的数据基础上，采用转述，翻译或者构建知识图谱的方法，增加数据的多样性；
2. 整合多种数据源或者增加元数据：可以丰富数据的背景信息，在搜索的时候也能提供更多的可操作性；

从数据的特性出发：

1. 文本数据中可能包含大量实体或者指代信息，通过数据标准化可以让模型更好地理解；
2. 数据可能包含一些有用的元数据，例如主题标签，时间等可以对数据进行大致分类，方便数据的检索和更迭；

## 文本数据的特殊处理

在处理基于文本数据的 RAG 优化问题时，由于文本表现形式的随意性，如何对文本进行有效的分块处理成为很关键的一步。块的质量和大小直接决定了下游模型的表现，然而块的大小通常与数据特征和用例也密不可分。在短文本 RAG 系统中，对文本进行进一步切分有助于精准检索；而在长文本或者复杂查询的时候，较长的上下文有助于模型理解或者推理。

通常的文本切分办法如下：

1. 固定长度切分：按照固定的上下文长度切分。各块之间可能有一定的重合。这样的分割好处是简单，能较好的控制长度，方面下游处理；
2. 段落或者句切分：语义上保证了数据块本身的连贯性，但是很多数据不会有明确的段落或者句子结构；
3. 递归切分：按照经验，对数据进行不同颗粒度的切分：先按照分隔，然后再按照句子切分。按照一定的条件进行细分；这样的好处是可以灵活调整分块的大小。
4. 语义切分： 根据数据的语义相似度进行线性聚类分割；
5. 结构化切分；对于半结构化的文本（Markdown，Latex，HTML 等），可以依靠已有的结构信息进行切分。

## 数据嵌入

数据嵌入是对数据的向量化表示。通常向量化模型的目标就是在压缩数据的同时减小数据的信息丢失。向量化能让数据检索大大简化的同时也提供了很好的语义性能。通常推荐的向量化模型都支持动态上下文建模，支持 subword，能很好地处理歧义和未知词。有条件的话，可以对模型进行进一步微调做数据领域的适配。

## 查询优化

常见的优化方法如下：

1. 重写：对查询进行重写，增加查询的上下文和信号；
2. 后退：提出一个比查询更抽象的问题，特别是用户输入特别具体的时候，抽象的后退问题能检索到更丰富的信息；
3. 多轮查询：用户的提问可能有相关性，在新查询中可以参考对话中的历史问题；
4. 假设查询：对于一个查询，模型可能在没有外部数据的情况下有一个假说，这个假说可以作为背景、参考信息一同查询；
5. 子问题或者相关问题查询：同时检索类似问题和子问题，增加数据召回率；

## 检索

从块的角度上，检索有以下优化方法：

1. 块压缩：如果块过大，可以通过文本总结进行数据压缩简化；
2. 块扩展：可以通过增加上下文窗口长度，使用父文档或者父节点进行信息扩充；
3. 混合检索：可以同时使用不同的检索方法，例如向量 + 关键词组合；
4. 路由：对不同种类或者需求的查询进行不同的检索；
5. Agent：Agent 可以对查询进行更灵活的检索决策；

## 重排序

语义相似度并不一定能捕捉相关度，重排可以和初始的检索结果进行相关度排序，这时候可以考虑用户的相关信息制定顺序；

## 生成

此时，查询到的相关数据应该已经具备解答问题的信息了，生成步骤的主要功能就是把这些数据进行整合和输出。优化可以从以下几个方面入手：

1. 多轮对话：通过对话来帮助用户更好地进行复杂查询，也更好地理解系统的特性和局限性；
2. 追问：在提供结果的同时可以向用户提问，帮助模型细化需求；
3. 提示词优化：针对生成模型的提示词优化，例如生成引用等；